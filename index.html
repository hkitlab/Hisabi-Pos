<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisabi POS - Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .swal2-popup { font-family: 'Inter', sans-serif; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .page { display: none; }
        .page.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Page (Login/Signup) -->
    <div id="authPage" class="page active min-h-screen w-full flex-col items-center justify-center bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h2 id="authTitle" class="text-3xl font-bold text-center text-gray-800">Login to Hisabi POS</h2>
            <form id="authForm" class="space-y-6">
                <input id="email" type="email" placeholder="Email Address" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="password" type="password" placeholder="Password" required class="w-full px-4 py-3 text-gray-700 bg-gray-100 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="authButton" type="submit" class="w-full py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Login
                </button>
            </form>
            <p class="text-sm text-center text-gray-600">
                <span id="authToggleText">Don't have an account?</span>
                <button id="authToggle" class="ml-1 font-semibold text-blue-600 hover:underline">Sign Up</button>
            </p>
        </div>
    </div>

    <!-- Main App Container (Hidden initially) -->
    <div id="appContainer" class="page flex-col h-screen w-full">
        <!-- Main Header -->
        <header class="flex items-center justify-between bg-white p-4 shadow-md z-10">
             <h1 class="text-3xl font-bold text-gray-800">Hisabi POS</h1>
             <nav class="flex items-center gap-4">
                 <button data-page="posPage" class="nav-btn px-4 py-2 font-semibold text-gray-700 rounded-lg hover:bg-blue-100 active:bg-blue-200"><i class="fas fa-cash-register mr-2"></i>POS</button>
                 <button data-page="productsPage" class="nav-btn px-4 py-2 font-semibold text-gray-700 rounded-lg hover:bg-blue-100"><i class="fas fa-box-open mr-2"></i>Products</button>
                 <button data-page="inventoryPage" class="nav-btn px-4 py-2 font-semibold text-gray-700 rounded-lg hover:bg-blue-100"><i class="fas fa-warehouse mr-2"></i>Inventory</button>
                 <button data-page="salesPage" class="nav-btn px-4 py-2 font-semibold text-gray-700 rounded-lg hover:bg-blue-100"><i class="fas fa-history mr-2"></i>Sales History</button>
                 <button data-page="settingsPage" class="nav-btn px-4 py-2 font-semibold text-gray-700 rounded-lg hover:bg-blue-100"><i class="fas fa-cog mr-2"></i>Invoice Settings</button>
                 <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
             </nav>
        </header>

        <!-- POS Page -->
        <div id="posPage" class="app-page active flex-1 overflow-hidden flex">
            <main class="flex-1 flex flex-col p-4 gap-4">
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm overflow-y-auto">
                    <div id="productGrid" class="product-grid"></div>
                    <p id="posLoading" class="text-center text-gray-500 p-10">Loading products...</p>
                </div>
            </main>
            <aside class="w-96 flex flex-col bg-white shadow-lg p-4">
                 <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Current Sale</h2>
                 <div id="cartItems" class="flex-1 py-4 overflow-y-auto"><p id="emptyCartMessage" class="text-center text-gray-400 mt-10">Your cart is empty</p></div>
                 <div class="border-t pt-4 space-y-3">
                     <div class="flex justify-between font-bold text-2xl text-gray-900"><span >Total</span><span id="total">৳0.00</span></div>
                     <button id="completeSaleBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg text-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>Complete Sale</button>
                 </div>
            </aside>
        </div>
        
        <!-- Products Page -->
        <div id="productsPage" class="app-page hidden flex-1 flex-col p-8 bg-gray-50">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Manage Products</h2>
                <button id="addProductBtn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Add New Product</button>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Stock</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Product rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventoryPage" class="app-page hidden flex-1 flex-col p-8 bg-gray-50">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Inventory Management</h2>
                <div>
                     <button id="addGodownBtn" class="mr-4 px-6 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600"><i class="fas fa-warehouse mr-2"></i>Manage Godowns</button>
                     <button id="addStockBtn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600"><i class="fas fa-plus mr-2"></i>Add Stock Batch</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Godown</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Inventory rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales History Page -->
        <div id="salesPage" class="app-page hidden flex-1 flex-col p-8 bg-gray-50">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Sales History</h2>
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sale ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesHistoryTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Sales history rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div id="settingsPage" class="app-page hidden flex-1 flex-col items-center p-8 bg-gray-50">
            <div class="w-full max-w-2xl">
                 <h2 class="text-3xl font-bold text-gray-800 mb-6">Invoice Settings</h2>
                 <div class="bg-white p-8 rounded-xl shadow-md">
                    <form id="settingsForm" class="space-y-4">
                         <p class="text-sm text-gray-600 mb-4">This information will appear on your printed invoices.</p>
                         <input id="businessName" placeholder="Business Name" class="w-full input" required>
                         <textarea id="businessAddress" placeholder="Business Address" class="w-full input" rows="3" required></textarea>
                         <input id="businessPhone" placeholder="Phone Number" class="w-full input">
                         <input id="businessEmail" type="email" placeholder="Email Address" class="w-full input">
                         <input id="invoiceLogoUrl" placeholder="Logo Image URL (optional)" class="w-full input">
                         <textarea id="invoiceFooter" placeholder="Invoice Footer Text (e.g., Thank you for your business!)" class="w-full input" rows="2"></textarea>
                         <button type="submit" class="w-full px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600">Save Settings</button>
                    </form>
                 </div>
            </div>
        </div>
    </div>

    <!-- CSS for Inputs -->
    <style>
        .input {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: ring 0.2s, border-color 0.2s;
        }
        .input:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
        }
        .nav-btn.active {
            background-color: #dbeafe;
            color: #2563eb;
            font-weight: 700;
        }
    </style>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc,
            query, where, getDocs, writeBatch, serverTimestamp, setDoc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- IMPORTANT: Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzLxLStBqHP2NOToJJ8z3kBpL6R39zaw8",
            authDomain: "hisabi-pos.firebaseapp.com",
            projectId: "hisabi-pos",
            storageBucket: "hisabi-pos.firebasestorage.app",
            messagingSenderId: "304545454743",
            appId: "1:304545454743:web:2a209bf46ec225d33ce7d2"
        };
        
        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);

        // Global State
        let currentUser = null;
        let products = [];
        let godowns = [];
        let stock = [];
        let sales = [];
        let cart = []; // { id, name, price, stock, quantity }
        let invoiceSettings = {};

        // --- UTILITY AND PAGE NAVIGATION ---
        const allAppPages = document.querySelectorAll('.app-page');
        const navButtons = document.querySelectorAll('.nav-btn');

        function showPage(pageId) {
            allAppPages.forEach(p => p.classList.replace('flex', 'hidden'));
            document.getElementById(pageId).classList.replace('hidden', 'flex');
            
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
        }
        
        navButtons.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));

        // --- AUTHENTICATION ---
        const authPage = document.getElementById('authPage');
        const appContainer = document.getElementById('appContainer');
        const authForm = document.getElementById('authForm');
        const authToggle = document.getElementById('authToggle');
        
        let isLogin = true;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authPage.classList.remove('active');
                appContainer.classList.add('active');
                showPage('posPage');
                initializeAppListeners();
            } else {
                currentUser = null;
                appContainer.classList.remove('active');
                authPage.classList.add('active');
                // Cleanup listeners if any
            }
        });

        authForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (isLogin) {
                signInWithEmailAndPassword(auth, email, password).catch(err => Swal.fire('Error', err.message, 'error'));
            } else {
                createUserWithEmailAndPassword(auth, email, password).catch(err => Swal.fire('Error', err.message, 'error'));
            }
        });

        authToggle.addEventListener('click', () => {
            isLogin = !isLogin;
            document.getElementById('authTitle').innerText = isLogin ? 'Login to Hisabi POS' : 'Create an Account';
            document.getElementById('authButton').innerText = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('authToggleText').innerText = isLogin ? "Don't have an account?" : 'Already have an account?';
            document.getElementById('authToggle').innerText = isLogin ? 'Sign Up' : 'Login';
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));


        // --- MAIN APP INITIALIZATION ---
        function initializeAppListeners() {
            if (!currentUser) return;
            // Products
            onSnapshot(collection(db, "products"), snapshot => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllViews();
            });
            // Godowns
            onSnapshot(collection(db, `users/${currentUser.uid}/godowns`), snapshot => {
                godowns = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
            // Stock
            onSnapshot(collection(db, "stock"), snapshot => {
                stock = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllViews();
            });
            // Sales
            onSnapshot(query(collection(db, "sales"), where("userId", "==", currentUser.uid)), snapshot => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSalesHistory();
            });
            // Settings
            onSnapshot(doc(db, `users/${currentUser.uid}/settings`, 'invoice'), snapshot => {
                if (snapshot.exists()) {
                    invoiceSettings = snapshot.data();
                    populateSettingsForm();
                }
            });
        }
        
        function updateAllViews() {
            renderPosProducts();
            renderProductsTable();
            renderInventoryTable();
        }

        // --- POS PAGE & CART ---
        const productGrid = document.getElementById('productGrid');
        const posLoading = document.getElementById('posLoading');
        const cartItemsContainer = document.getElementById('cartItems');
        const completeSaleBtn = document.getElementById('completeSaleBtn');
        const totalEl = document.getElementById('total');

        function renderPosProducts() {
             productGrid.innerHTML = '';
             posLoading.style.display = 'none';

             if (products.length === 0) {
                 productGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">No products available. Add some in the "Products" tab.</p>';
                 return;
             }

             products.forEach(product => {
                const totalStock = stock.filter(s => s.productId === product.id).reduce((sum, s) => sum + s.quantity, 0);
                const isOutOfStock = totalStock <= 0;
                
                const card = document.createElement('div');
                card.className = `p-3 border rounded-lg flex flex-col text-center cursor-pointer transition-shadow shadow-sm hover:shadow-md ${isOutOfStock ? 'bg-gray-200 opacity-60' : 'bg-white'}`;
                if (!isOutOfStock) card.onclick = () => addToCart(product.id);
                
                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-semibold text-gray-800">${product.name}</h3>
                        <p class="text-blue-600 font-bold">৳${product.price.toFixed(2)}</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Stock: ${totalStock}</p>
                    ${isOutOfStock ? '<p class="text-xs font-bold text-red-500">Out of Stock</p>' : ''}
                `;
                productGrid.appendChild(card);
            });
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const totalStock = stock.filter(s => s.productId === productId).reduce((sum, s) => sum + s.quantity, 0);
            const cartItem = cart.find(item => item.id === productId);

            if (cartItem) {
                if (cartItem.quantity < totalStock) {
                    cartItem.quantity++;
                } else {
                    Swal.fire('Stock Limit', 'Cannot add more than available stock.', 'warning');
                }
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            renderCart();
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                 cartItemsContainer.innerHTML = '<p id="emptyCartMessage" class="text-center text-gray-400 mt-10">Your cart is empty</p>';
                 completeSaleBtn.disabled = true;
            } else {
                completeSaleBtn.disabled = false;
                cart.forEach(item => {
                    const totalStock = stock.filter(s => s.productId === item.id).reduce((sum, s) => sum + s.quantity, 0);
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-50';
                    el.innerHTML = `
                        <div class="flex-1 pr-2">
                            <p class="font-semibold text-gray-800 truncate">${item.name}</p>
                            <p class="text-sm text-gray-600">৳${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <input type="number" min="1" max="${totalStock}" value="${item.quantity}" class="w-16 text-center border rounded-md p-1" onchange="window.updateCartQuantity('${item.id}', parseInt(this.value))">
                             <button class="text-red-500 hover:text-red-700" onclick="window.removeFromCart('${item.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(el);
                });
            }
            updateTotals();
        }

        window.updateCartQuantity = (productId, newQuantity) => {
            const cartItem = cart.find(item => item.id === productId);
            const totalStock = stock.filter(s => s.productId === productId).reduce((sum, s) => sum + s.quantity, 0);
            if (newQuantity > 0 && newQuantity <= totalStock) {
                cartItem.quantity = newQuantity;
            } else if (newQuantity > totalStock) {
                cartItem.quantity = totalStock;
                Swal.fire('Stock Limit', `Only ${totalStock} available.`, 'warning');
            } else {
                cart = cart.filter(item => item.id !== productId);
            }
            renderCart();
        };

        window.removeFromCart = (productId) => {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        };

        function updateTotals() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalEl.textContent = `৳${total.toFixed(2)}`;
        }

        // --- PRODUCTS PAGE ---
        const productsTableBody = document.getElementById('productsTableBody');
        document.getElementById('addProductBtn').addEventListener('click', async () => {
             const { value: formValues } = await Swal.fire({
                title: 'Add New Product',
                html:
                    '<input id="swal-name" class="swal2-input" placeholder="Product Name">' +
                    '<input id="swal-sku" class="swal2-input" placeholder="SKU (Stock Keeping Unit)">' +
                    '<input id="swal-price" type="number" class="swal2-input" placeholder="Price (৳)">',
                focusConfirm: false,
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const sku = document.getElementById('swal-sku').value;
                    const price = parseFloat(document.getElementById('swal-price').value);
                    if (!name || !sku || !price ) return Swal.showValidationMessage('Please fill all fields.');
                    return { name, sku, price };
                }
            });
            if (formValues) {
                await addDoc(collection(db, 'products'), formValues);
                Swal.fire('Success', 'Product added!', 'success');
            }
        });
        
        function renderProductsTable() {
            productsTableBody.innerHTML = '';
            products.forEach(p => {
                const totalStock = stock.filter(s => s.productId === p.id).reduce((sum, s) => sum + s.quantity, 0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${p.sku}</td>
                    <td class="px-6 py-4 whitespace-nowrap">৳${p.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${totalStock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="window.removeProduct('${p.id}')"><i class="fas fa-trash-alt"></i> Delete</button>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });
        }
        
        window.removeProduct = async (productId) => {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this! This will also remove associated stock records.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });
            if (result.isConfirmed) {
                await deleteDoc(doc(db, 'products', productId));
                // Also remove stock associated with this product
                const stockQuery = query(collection(db, 'stock'), where('productId', '==', productId));
                const stockSnapshot = await getDocs(stockQuery);
                const batch = writeBatch(db);
                stockSnapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();

                Swal.fire('Deleted!', 'Product has been removed.', 'success');
            }
        };

        // --- INVENTORY PAGE ---
        const inventoryTableBody = document.getElementById('inventoryTableBody');

        document.getElementById('addGodownBtn').addEventListener('click', async () => {
             const { value: name } = await Swal.fire({
                title: 'Add New Godown/Warehouse',
                input: 'text',
                inputLabel: 'Godown Name',
                inputPlaceholder: 'e.g., Main Warehouse, Shop Floor',
                showCancelButton: true,
             });
             if (name) {
                 await addDoc(collection(db, `users/${currentUser.uid}/godowns`), { name });
                 Swal.fire('Success', 'Godown added!', 'success');
             }
        });
        
        document.getElementById('addStockBtn').addEventListener('click', async () => {
            if (products.length === 0 || godowns.length === 0) {
                Swal.fire('Prerequisite Missing', 'Please add at least one product and one godown before adding stock.', 'warning');
                return;
            }
            const productOptions = products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            const godownOptions = godowns.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

            const { value: formValues } = await Swal.fire({
                title: 'Add Stock Batch',
                html: `
                    <select id="swal-product" class="swal2-select">${productOptions}</select>
                    <select id="swal-godown" class="swal2-select">${godownOptions}</select>
                    <input id="swal-quantity" type="number" class="swal2-input" placeholder="Quantity">`,
                focusConfirm: false,
                preConfirm: () => ({
                    productId: document.getElementById('swal-product').value,
                    godownId: document.getElementById('swal-godown').value,
                    quantity: parseInt(document.getElementById('swal-quantity').value)
                })
            });

            if(formValues && formValues.quantity > 0) {
                const stockQuery = query(collection(db, 'stock'), where('productId', '==', formValues.productId), where('godownId', '==', formValues.godownId));
                const stockSnapshot = await getDocs(stockQuery);
                if (stockSnapshot.empty) {
                    await addDoc(collection(db, 'stock'), formValues);
                } else {
                    const docRef = stockSnapshot.docs[0].ref;
                    const currentQuantity = stockSnapshot.docs[0].data().quantity;
                    await updateDoc(docRef, { quantity: currentQuantity + formValues.quantity });
                }
                Swal.fire('Success', 'Stock updated!', 'success');
            }
        });

        function renderInventoryTable() {
            inventoryTableBody.innerHTML = '';
             stock.forEach(s => {
                const product = products.find(p => p.id === s.productId);
                const godown = godowns.find(g => g.id === s.godownId);
                if (!product || !godown) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${product.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${godown.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${s.quantity}</td>
                `;
                inventoryTableBody.appendChild(row);
            });
        }
        
        // --- SALES & INVOICING ---
        const salesHistoryTableBody = document.getElementById('salesHistoryTableBody');

        completeSaleBtn.addEventListener('click', async () => {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const saleData = {
                userId: currentUser.uid,
                items: cart,
                totalAmount: total,
                createdAt: serverTimestamp()
            };
            
            const batch = writeBatch(db);
            // 1. Record the sale
            const saleRef = doc(collection(db, 'sales'));
            batch.set(saleRef, saleData);
            
            // 2. Update stock
            for (const item of cart) {
                let quantityToDeduct = item.quantity;
                const stockRecords = stock.filter(s => s.productId === item.id && s.quantity > 0);
                
                for (const record of stockRecords) {
                    const docRef = doc(db, 'stock', record.id);
                    if (record.quantity >= quantityToDeduct) {
                        batch.update(docRef, { quantity: record.quantity - quantityToDeduct });
                        quantityToDeduct = 0;
                        break;
                    } else {
                        quantityToDeduct -= record.quantity;
                        batch.update(docRef, { quantity: 0 });
                    }
                }
            }

            await batch.commit();
            const result = await Swal.fire({
                title: 'Sale Complete!',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-print"></i> Print Invoice',
                cancelButtonText: 'New Sale'
            });

            if (result.isConfirmed) {
                printInvoice(saleRef.id, saleData);
            }
            cart = [];
            renderCart();
        });
        
        function renderSalesHistory() {
             salesHistoryTableBody.innerHTML = '';
             sales.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()).forEach(s => {
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.id.substring(0, 8)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${new Date(s.createdAt.seconds * 1000).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${s.items.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap">৳${s.totalAmount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900" onclick="window.printInvoice('${s.id}')"><i class="fas fa-print"></i> Print</button>
                    </td>
                 `;
                 salesHistoryTableBody.appendChild(row);
             });
        }
        
        window.printInvoice = async (saleId, saleData = null) => {
            let sale = saleData;
            if (!sale) {
                const docSnap = await getDoc(doc(db, 'sales', saleId));
                sale = docSnap.data();
            }
            if(!sale) return;

            const { businessName, businessAddress, businessPhone, businessEmail, invoiceLogoUrl, invoiceFooter } = invoiceSettings;
            
            let itemsHtml = '';
            sale.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td class="py-2 px-4 border-b">${item.name}</td>
                        <td class="py-2 px-4 border-b text-center">${item.quantity}</td>
                        <td class="py-2 px-4 border-b text-right">৳${item.price.toFixed(2)}</td>
                        <td class="py-2 px-4 border-b text-right">৳${(item.quantity * item.price).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            const invoiceHtml = `
                <html><head><title>Invoice #${saleId.substring(0,8)}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style> @media print { body { -webkit-print-color-adjust: exact; } .no-print { display: none; } } </style>
                </head>
                <body class="bg-gray-100 p-8">
                    <div class="max-w-3xl mx-auto bg-white p-10 rounded-lg shadow-xl">
                        <header class="flex justify-between items-center border-b pb-6 mb-8">
                            <div>
                                ${invoiceLogoUrl ? `<img src="${invoiceLogoUrl}" alt="Logo" class="h-16 mb-4">` : ''}
                                <h1 class="text-4xl font-bold text-gray-800">${businessName || 'Your Company'}</h1>
                                <p class="text-gray-500">${businessAddress || ''}</p>
                                <p class="text-gray-500">${businessPhone || ''}</p>
                                <p class="text-gray-500">${businessEmail || ''}</p>
                            </div>
                            <div class="text-right">
                                <h2 class="text-2xl font-semibold text-gray-700">INVOICE</h2>
                                <p class="text-gray-500">#${saleId.substring(0,8)}</p>
                                <p class="text-gray-500">Date: ${new Date(sale.createdAt?.seconds * 1000).toLocaleDateString()}</p>
                            </div>
                        </header>
                        <main>
                            <table class="w-full mb-8">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="py-2 px-4 text-left font-semibold text-gray-600">Item</th>
                                        <th class="py-2 px-4 text-center font-semibold text-gray-600">Quantity</th>
                                        <th class="py-2 px-4 text-right font-semibold text-gray-600">Unit Price</th>
                                        <th class="py-2 px-4 text-right font-semibold text-gray-600">Total</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsHtml}</tbody>
                            </table>
                            <div class="flex justify-end">
                                <div class="w-64">
                                    <div class="flex justify-between text-lg font-bold text-gray-800">
                                        <span>Total</span>
                                        <span>৳${sale.totalAmount.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </main>
                        <footer class="text-center text-gray-500 pt-8 mt-8 border-t">
                            <p>${invoiceFooter || 'Thank you for your business!'}</p>
                        </footer>
                    </div>
                    <div class="text-center mt-6 no-print">
                       <button onclick="window.print()" class="px-6 py-2 bg-blue-600 text-white rounded shadow">Print</button>
                       <button onclick="window.close()" class="px-6 py-2 bg-gray-400 text-white rounded shadow">Close</button>
                    </div>
                </body></html>`;
            const win = window.open('', '_blank');
            win.document.write(invoiceHtml);
            win.document.close();
        }

        // --- SETTINGS PAGE ---
        const settingsForm = document.getElementById('settingsForm');

        function populateSettingsForm() {
            if (!invoiceSettings) return;
            document.getElementById('businessName').value = invoiceSettings.businessName || '';
            document.getElementById('businessAddress').value = invoiceSettings.businessAddress || '';
            document.getElementById('businessPhone').value = invoiceSettings.businessPhone || '';
            document.getElementById('businessEmail').value = invoiceSettings.businessEmail || '';
            document.getElementById('invoiceLogoUrl').value = invoiceSettings.invoiceLogoUrl || '';
            document.getElementById('invoiceFooter').value = invoiceSettings.invoiceFooter || '';
        }

        settingsForm.addEventListener('submit', async e => {
            e.preventDefault();
            const settingsData = {
                businessName: document.getElementById('businessName').value,
                businessAddress: document.getElementById('businessAddress').value,
                businessPhone: document.getElementById('businessPhone').value,
                businessEmail: document.getElementById('businessEmail').value,
                invoiceLogoUrl: document.getElementById('invoiceLogoUrl').value,
                invoiceFooter: document.getElementById('invoiceFooter').value,
            };
            await setDoc(doc(db, `users/${currentUser.uid}/settings`, 'invoice'), settingsData);
            Swal.fire('Saved!', 'Your invoice settings have been updated.', 'success');
        });

    </script>
</body>
</html>